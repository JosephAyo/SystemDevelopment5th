name: Run Tests

on:
    push:
        branches: [ main, master, develop ]
    pull_request:
        branches: [ main, master, develop ]

permissions:
  contents: write
  pull-requests: write

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.8", "3.9", "3.10", "3.11"]
        steps:
            - uses: actions/checkout@v3
            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v4
              with:
                  python-version: ${{ matrix.python-version }}
            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install pytest pytest-cov
                  if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
            - name: Run tests with coverage
              run: |
                    pytest tests/ -v --cov=src --cov-report=term-missing --cov-report=html | tee pytest-coverage.txt
            - name: Upload coverage HTML report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: coverage-report-${{ matrix.python-version }}
                  path: htmlcov/
            - name: Pytest coverage comment
              if: matrix.python-version == '3.9'
              uses: MishaKav/pytest-coverage-comment@main
              with:
                pytest-coverage-path: ./pytest-coverage.txt
                junitxml-path: ./pytest.xml

            - name: Generate Coverage Badge
              if: matrix.python-version == '3.9'
              run: |
                pip install coverage-badge
                coverage-badge -o coverage.svg -f

            - name: Commit Coverage Badge
              if: matrix.python-version == '3.9'
              run: |
                git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
                git config --local user.name "github-actions[bot]"
                git add coverage.svg
                git commit -m "Update coverage badge" || echo "No changes to commit"
                git push
            - name: Coverage summary
              if: matrix.python-version == '3.9'
              run: |
                  echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  cat pytest-coverage.txt | grep -E "(TOTAL|Name)" | tail -n 2 >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY